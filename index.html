<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcella Volley Scoreboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        .animate-fall {
            animation: fall linear forwards;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .overflow-y-auto::-webkit-scrollbar {
            display: none;
        }
        /* Prevent text selection on double-click and drag */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Team Panel Styles */
        .team-panel {
            width: calc((100vw - 10rem) / 2);
        }

        /* Logo Styles */
        .logo-size {
            height: clamp(6rem, 15vh, 18rem);
            width: clamp(6rem, 15vh, 18rem);
        }

        /* Reserve space for logo even when empty */
        .logo-container {
            min-height: clamp(6rem, 15vh, 18rem);
            min-width: clamp(6rem, 15vh, 18rem);
            height: clamp(6rem, 15vh, 18rem);
            width: clamp(6rem, 15vh, 18rem);
        }

        .logo-placeholder-text {
            font-size: clamp(0.65rem, 0.8vw, 0.85rem);
        }

        /* Team Name */
        .team-name {
            font-size: clamp(1.75rem, 3vw, 3.5rem);
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        /* Shrink team name when it gets long */
        .team-name.medium {
            font-size: clamp(1.25rem, 2.5vw, 2.75rem);
        }

        .team-name.small {
            font-size: clamp(1rem, 2vw, 2rem);
        }

        /* Timeout Styles */
        .timeout-label {
            font-size: 1rem; /* text-4xl */
        }

        .timeout-number {
            font-size: 6.5rem; /* text-6xl */
        }

        /* Score Styles */
        .score-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .score-display {
            font-size: min(45vw, 70vh);
            line-height: 0.85;
            font-stretch: condensed;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            white-space: nowrap;
        }

        /* Shrink score text when numbers get large */
        .score-display.large {
            font-size: min(30vw, 52vh);
        }

        .score-display.very-large {
            font-size: min(25vw, 50vh);
        }

        /* Top Bar Styles */
        .venue-text {
            font-size: clamp(1.5rem, 2.5vw, 2.5rem);
        }

        .date-text {
            font-size: clamp(1.25rem, 2vw, 2rem);
        }

        /* Current Set Styles */
        .current-set-label {
            font-size: clamp(1.5rem, 2.25vw, 2.25rem);
        }

        .current-set-number {
            font-size: clamp(4.5rem, 9.5vw, 10rem);
            margin-top: -40px;
            margin-bottom: -40px;
        }

        /* Sets Won Styles */
        .sets-label {
            font-size: clamp(1rem, 1.5vw, 1.5rem);
            margin-bottom: -20px
        }

        .sets-number {
            font-size: clamp(3rem, 5vw, 5rem);
        }

        /* Winner Message */
        .winner-message {
            font-size: clamp(3rem, 6vw, 6rem);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide Icons (simplified versions)
        const Menu = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        );

        const RotateCw = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
        );

        const Flag = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
            </svg>
        );

        const Edit = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        );

        // Team Panel Component
        function TeamPanel({
            side,
            team,
            matchStarted,
            manualEditMode,
            onChangeName,
            onChangeLogo,
            onUpdateTimeouts,
            onUpdateScore
        }) {
            const isLeft = side === 'left';
            const flexOrderClass = isLeft ? '' : 'flex-row-reverse';

            // Determine score size class based on score value
            const getScoreClass = (score) => {
                if (score >= 100) return 'very-large';
                if (score >= 10) return 'large';
                return '';
            };

            // Determine team name size class based on name length
            const getTeamNameClass = (name) => {
                const length = name.length;
                if (length > 20) return 'small';
                if (length > 15) return 'medium';
                return '';
            };

            return (
                <div className={`team-panel flex-shrink-0 ${team.theme.bgColor} ${team.theme.textColor} flex flex-col`}>
                    {/* Two-column layout */}
                    <div className={`flex ${flexOrderClass} h-full`}>
                        {/* Column 1: Logo, Timeout, and Score Minus Button */}
                        <div className="flex flex-col items-center justify-between p-6 h-full">
                            <div className="flex flex-col items-center gap-6">
                                {/* Logo with reserved space */}
                                <div
                                    className={`logo-container flex-shrink-0 ${matchStarted ? '' : 'cursor-pointer'}`}
                                    onClick={matchStarted ? undefined : () => onChangeLogo(side)}
                                >
                                    {team.logo ? (
                                        <img
                                            src={team.logo}
                                            alt={`${team.name} Logo`}
                                            className={`logo-size object-contain ${matchStarted ? '' : 'hover:opacity-70 transition'}`}
                                        />
                                    ) : (
                                        <div className="logo-size border-2 border-dashed border-gray-400 rounded flex items-center justify-center hover:border-gray-600 transition">
                                            {!matchStarted && (
                                                <span className="logo-placeholder-text text-gray-500">
                                                    + Logo
                                                </span>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {/* Timeouts */}
                                <div className="flex items-center gap-2">
                                    {manualEditMode && (
                                        <button
                                            onClick={() => onUpdateTimeouts(side, -1)}
                                            className={`${team.theme.buttonBg} ${team.theme.buttonText} ${team.theme.buttonHover} w-12 h-12 rounded-full text-2xl font-bold transition`}
                                        >
                                            -
                                        </button>
                                    )}
                                    <div
                                        className="cursor-pointer hover:opacity-70 transition text-center"
                                        onClick={() => onUpdateTimeouts(side, 1)}
                                    >
                                        <div className="timeout-label font-bold">TIMEOUT</div>
                                        <div className="timeout-number font-bold" style={{ marginTop: '-30px' }}>{team.timeouts}</div>
                                    </div>
                                </div>
                            </div>

                            {/* Score Minus Button - At Bottom */}
                            <button
                                onClick={() => onUpdateScore(side, -1)}
                                className={`${team.theme.buttonBg} ${team.theme.buttonText} ${team.theme.buttonHover} w-20 h-20 rounded-full text-4xl font-bold transition flex-shrink-0`}
                            >
                                -
                            </button>
                        </div>

                        {/* Column 2: Team Name and Score (larger column, closer to center) */}
                        <div className="flex-1 flex flex-col py-6">
                            {/* Team Name */}
                            <div className="text-center px-4 flex-shrink-0">
                                <div
                                    className="cursor-pointer hover:opacity-70 transition p-2 rounded"
                                    onClick={() => onChangeName(side)}
                                >
                                    <h2 className={`team-name ${getTeamNameClass(team.name)} font-bold uppercase`}>
                                        {team.name}
                                    </h2>
                                </div>
                            </div>

                            {/* Score */}
                            <div className="flex-1 flex items-center justify-center min-h-0 px-4">
                                <div className="score-container">
                                    <div
                                        className={`score-display ${getScoreClass(team.score)} font-bold cursor-pointer hover:opacity-70 transition leading-none text-center`}
                                        onClick={() => onUpdateScore(side, 1)}
                                    >
                                        {team.score}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function VolleyScoreboard() {
            // Storage version - increment when breaking changes occur
            const STORAGE_VERSION = 2;

            // Default team configurations
            const DEFAULT_LEFT_TEAM = {
                name: 'Arcella Volley',
                score: 0,
                sets: 0,
                timeouts: 0,
                logo: 'https://www.arcellavolley.it/file/2014/05/Loghi-in-alto_051.png',
                theme: {
                    bgColor: 'bg-black',
                    textColor: 'text-white',
                    buttonBg: 'bg-white',
                    buttonText: 'text-black',
                    buttonHover: 'hover:bg-gray-200'
                }
            };

            const DEFAULT_RIGHT_TEAM = {
                name: 'Squadra Ospite',
                score: 0,
                sets: 0,
                timeouts: 0,
                logo: '',
                theme: {
                    bgColor: 'bg-white',
                    textColor: 'text-black',
                    buttonBg: 'bg-black',
                    buttonText: 'text-white',
                    buttonHover: 'hover:bg-gray-800'
                }
            };

            const [teamData, setTeamData] = useState({
                left: DEFAULT_LEFT_TEAM,
                right: DEFAULT_RIGHT_TEAM
            });

            const [setHistory, setSetHistory] = useState([]);
            const [menuOpen, setMenuOpen] = useState(false);
            const [manualEditMode, setManualEditMode] = useState(false);
            const [showConfetti, setShowConfetti] = useState(false);
            const [winnerMessage, setWinnerMessage] = useState('');

            const maxTimeouts = 2;

            // Load from localStorage on mount
            useEffect(() => {
                const saved = localStorage.getItem('volleyScoreboard');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);

                        // Check version - if mismatch, ignore saved data
                        if (data.version !== STORAGE_VERSION) {
                            console.log('Storage version mismatch - using defaults');
                            return;
                        }

                        // Load with defaults as fallback
                        setTeamData({
                            left: { ...DEFAULT_LEFT_TEAM, ...data.teamData.left },
                            right: { ...DEFAULT_RIGHT_TEAM, ...data.teamData.right }
                        });
                        setSetHistory(data.setHistory || []);
                    } catch (e) {
                        console.error('Error loading saved data:', e);
                    }
                }
            }, []);

            // Save to localStorage whenever state changes
            useEffect(() => {
                const data = {
                    version: STORAGE_VERSION,
                    teamData,
                    setHistory
                };
                localStorage.setItem('volleyScoreboard', JSON.stringify(data));
            }, [teamData, setHistory]);

            const updateScore = (team, delta) => {
                const newScore = Math.max(0, teamData[team].score + delta);
                setTeamData({
                    ...teamData,
                    [team]: { ...teamData[team], score: newScore }
                });
            };

            const updateSets = (team, delta) => {
                const newSets = Math.max(0, teamData[team].sets + delta);
                setTeamData({
                    ...teamData,
                    [team]: { ...teamData[team], sets: newSets }
                });
            };

            const updateTimeouts = (team, delta) => {
                const newTimeouts = Math.max(0, Math.min(maxTimeouts, teamData[team].timeouts + delta));
                setTeamData({
                    ...teamData,
                    [team]: { ...teamData[team], timeouts: newTimeouts }
                });
            };

            const changeName = (team) => {
                const newName = prompt(`Inserisci il nome della squadra:`, teamData[team].name);
                if (newName && newName.trim()) {
                    setTeamData({
                        ...teamData,
                        [team]: { ...teamData[team], name: newName.trim() }
                    });
                }
            };

            const changeLogo = (team) => {
                const newLogo = prompt(`Inserisci l'URL del logo:`, teamData[team].logo);
                if (newLogo !== null) {
                    setTeamData({
                        ...teamData,
                        [team]: { ...teamData[team], logo: newLogo.trim() }
                    });
                }
            };

            const switchSides = () => {
                setTeamData({
                    left: teamData.right,
                    right: teamData.left
                });
                setMenuOpen(false);
            };

            const endSet = () => {
                const winner = teamData.left.score > teamData.right.score ? 'left' : 'right';
                const loser = winner === 'left' ? 'right' : 'left';
                const winnerName = teamData[winner].name;

                if (teamData.left.score === teamData.right.score) {
                    alert('Il punteggio è pari! Non è possibile terminare il set.');
                    return;
                }

                setWinnerMessage(`${winnerName} ha vinto il set!`);
                setShowConfetti(true);

                // Save set history with team info and theme
                setSetHistory([...setHistory, {
                    leftScore: teamData.left.score,
                    rightScore: teamData.right.score,
                    leftTeamName: teamData.left.name,
                    rightTeamName: teamData.right.name,
                    winnerName: winnerName,
                    winnerTheme: teamData[winner].theme
                }]);

                setTimeout(() => {
                    // Increment set count for winner, reset scores and timeouts for both teams, then switch sides
                    setTeamData({
                        left: { ...teamData[loser], score: 0, timeouts: 0 },
                        right: { ...teamData[winner], sets: teamData[winner].sets + 1, score: 0, timeouts: 0 }
                    });

                    setTimeout(() => {
                        setShowConfetti(false);
                        setWinnerMessage('');
                    }, 500);
                }, 3000);

                setMenuOpen(false);
            };

            const resetSet = () => {
                if (confirm('Sei sicuro di voler resettare il set corrente?')) {
                    setTeamData({
                        left: { ...teamData.left, score: 0, timeouts: 0 },
                        right: { ...teamData.right, score: 0, timeouts: 0 }
                    });
                    setMenuOpen(false);
                }
            };

            const resetMatch = () => {
                if (confirm('Sei sicuro di voler resettare la partita?')) {
                    setTeamData({
                        left: DEFAULT_LEFT_TEAM,
                        right: DEFAULT_RIGHT_TEAM
                    });
                    setSetHistory([]);
                    setMenuOpen(false);
                }
            };

            const toggleManualEdit = () => {
                setManualEditMode(!manualEditMode);
                setMenuOpen(false);
            };

            const getCurrentDate = () => {
                const today = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return today.toLocaleDateString('it-IT', options);
            };

            const getCurrentSet = () => {
                return teamData.left.sets + teamData.right.sets + 1;
            };

            const matchStarted = teamData.left.score > 0 || teamData.right.score > 0 || teamData.left.sets > 0 || teamData.right.sets > 0;

            return (
                <div className="h-screen bg-black text-white flex flex-col relative overflow-hidden">
                    {/* Confetti Overlay */}
                    {showConfetti && (
                        <div className="fixed inset-0 z-50 pointer-events-none overflow-hidden">
                            <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                                <div className="winner-message font-bold text-yellow-400 animate-pulse">
                                    {winnerMessage}
                                </div>
                            </div>
                            {[...Array(50)].map((_, i) => (
                                <div
                                    key={i}
                                    className="absolute animate-fall"
                                    style={{
                                        left: `${Math.random() * 100}%`,
                                        top: `-20px`,
                                        animationDelay: `${Math.random() * 0.5}s`,
                                        animationDuration: `${2 + Math.random() * 2}s`
                                    }}
                                >
                                    <div
                                        className={`w-3 h-3 ${
                                            Math.random() > 0.5 ? 'bg-yellow-400' : 'bg-white'
                                        } rounded-full`}
                                    />
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Top Stripe - Venue and Date */}
                    <div className="bg-yellow-400 text-black py-3 px-6">
                        <div className="flex justify-between items-center">
                            <div className="venue-text font-bold">
                                Palestra "R. Barion"
                            </div>
                            <div className="date-text font-semibold">
                                {getCurrentDate()}
                            </div>
                        </div>
                    </div>

                    {/* Main Scoreboard */}
                    <div className="flex-1 flex min-h-0">
                        <TeamPanel
                            side="left"
                            team={teamData.left}
                            matchStarted={matchStarted}
                            manualEditMode={manualEditMode}
                            onChangeName={changeName}
                            onChangeLogo={changeLogo}
                            onUpdateTimeouts={updateTimeouts}
                            onUpdateScore={updateScore}
                        />

                        {/* Center Divider with Menu and Current Set */}
                        <div className="w-40 bg-yellow-400 flex flex-col relative">
                            {/* Current Set Indicator - At Top */}
                            <div className="py-6 text-center border-b-2 border-black">
                                <div className="current-set-label text-black font-bold mb-2">
                                    SET
                                </div>
                                <div className="current-set-number text-black font-bold">
                                    {getCurrentSet()}
                                </div>
                            </div>

                            {/* Sets Won Display */}
                            <div className="py-4 text-center border-b-2 border-black">
                                <div className="sets-label text-black font-bold">
                                    SET
                                </div>
                                <div className="flex justify-center items-center gap-4">
                                    <div className="sets-number text-black font-bold">{teamData.left.sets}</div>
                                    <div className="text-black font-bold text-2xl">-</div>
                                    <div className="sets-number text-black font-bold">{teamData.right.sets}</div>
                                </div>
                            </div>

                            {/* Set History Bubbles - Vertically Stacked */}
                            <div className="flex-1 flex flex-col items-center justify-start py-4 overflow-y-auto">
                                {setHistory.length > 0 && (
                                    <div className="flex flex-col gap-4 w-full px-4">
                                        {setHistory.map((set, index) => {
                                            // Use the saved winner theme for color
                                            const winnerTheme = set.winnerTheme || { bgColor: 'bg-black', textColor: 'text-white' };
                                            const winnerColor = `${winnerTheme.bgColor} ${winnerTheme.textColor}`;

                                            // Determine scores based on CURRENT team positions
                                            // We need to find which historical score belongs to the current left/right team
                                            let currentLeftScore, currentRightScore;

                                            // Check if the current left team was on the left when this set was played
                                            if (teamData.left.name === set.leftTeamName) {
                                                // No swap needed - current left was historical left
                                                currentLeftScore = set.leftScore;
                                                currentRightScore = set.rightScore;
                                            } else {
                                                // Swap needed - current left was historical right
                                                currentLeftScore = set.rightScore;
                                                currentRightScore = set.leftScore;
                                            }

                                            return (
                                                <div
                                                    key={index}
                                                    className={`${winnerColor} rounded-lg px-2 py-2 text-center`}
                                                >
                                                    <div className="flex items-center justify-center gap-2">
                                                        <span className="text-lg font-semibold">#{index + 1}:</span>
                                                        <span className="font-bold text-2xl">{currentLeftScore}-{currentRightScore}</span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>

                            {/* Menu Button */}
                            <div className="relative">
                                <button
                                    onClick={() => setMenuOpen(!menuOpen)}
                                    className="w-full py-4 bg-yellow-400 text-black hover:bg-yellow-500 transition flex items-center justify-center"
                                >
                                    <Menu size={24} />
                                </button>

                                {menuOpen && (
                                    <div className="absolute bottom-full left-0 right-0 bg-black border-2 border-yellow-400 shadow-lg">
                                        <button
                                            onClick={endSet}
                                            className="w-full py-3 px-4 text-yellow-400 hover:bg-gray-900 transition flex items-center justify-center gap-2 border-b border-yellow-400"
                                        >
                                            <Flag size={18} />
                                            <span className="text-sm">Fine Set</span>
                                        </button>
                                        <button
                                            onClick={switchSides}
                                            className="w-full py-3 px-4 text-yellow-400 hover:bg-gray-900 transition flex items-center justify-center gap-2 border-b border-yellow-400"
                                        >
                                            <RotateCw size={18} />
                                            <span className="text-sm">Cambia Lato</span>
                                        </button>
                                        <button
                                            onClick={toggleManualEdit}
                                            className="w-full py-3 px-4 text-yellow-400 hover:bg-gray-900 transition flex items-center justify-center gap-2 border-b border-yellow-400"
                                        >
                                            <Edit size={18} />
                                            <span className="text-sm">{manualEditMode ? 'Esci Modifica' : 'Modifica Manuale'}</span>
                                        </button>
                                        <button
                                            onClick={resetSet}
                                            className="w-full py-3 px-4 text-yellow-400 hover:bg-gray-900 transition flex items-center justify-center gap-2 border-b border-yellow-400"
                                        >
                                            <RotateCw size={18} />
                                            <span className="text-sm">Reset Set</span>
                                        </button>
                                        <button
                                            onClick={resetMatch}
                                            className="w-full py-3 px-4 text-yellow-400 hover:bg-gray-900 transition flex items-center justify-center gap-2"
                                        >
                                            <RotateCw size={18} />
                                            <span className="text-sm">Reset Partita</span>
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>

                        <TeamPanel
                            side="right"
                            team={teamData.right}
                            matchStarted={matchStarted}
                            manualEditMode={manualEditMode}
                            onChangeName={changeName}
                            onChangeLogo={changeLogo}
                            onUpdateTimeouts={updateTimeouts}
                            onUpdateScore={updateScore}
                        />
                    </div>
                </div>
            );
        }

        ReactDOM.render(<VolleyScoreboard />, document.getElementById('root'));
    </script>
</body>
</html>
