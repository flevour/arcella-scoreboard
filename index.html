<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcella Volley Scoreboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        .animate-fall {
            animation: fall linear forwards;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .overflow-y-auto::-webkit-scrollbar {
            display: none;
        }
        /* Prevent text selection on double-click and drag */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide Icons (simplified versions)
        const Menu = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        );

        const RotateCw = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
        );

        const Flag = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
            </svg>
        );

        const Edit = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        );

        // Team Panel Component
        function TeamPanel({
            side,
            team,
            matchStarted,
            manualEditMode,
            onChangeName,
            onChangeLogo,
            onUpdateTimeouts,
            onUpdateScore
        }) {
            const isLeft = side === 'left';
            const alignClass = isLeft ? 'items-start' : 'items-end';
            const textAlignClass = isLeft ? 'text-left' : 'text-right';
            const flexOrderClass = isLeft ? '' : 'flex-row-reverse';

            return (
                <div className={`flex-1 ${team.theme.bgColor} ${team.theme.textColor} flex flex-col`}>
                    {/* Header with Logo and Team Name */}
                    <div className={`p-6 flex flex-col ${alignClass} gap-4`}>
                        <div className={`flex items-center gap-4 w-full ${flexOrderClass}`}>
                            {/* Logo */}
                            <div
                                className={matchStarted ? '' : 'cursor-pointer'}
                                onClick={matchStarted ? undefined : () => onChangeLogo(side)}
                            >
                                {team.logo ? (
                                    <img
                                        src={team.logo}
                                        alt={`${team.name} Logo`}
                                        style={{ height: 'clamp(6rem, 15vh, 18rem)', width: 'clamp(6rem, 15vh, 18rem)' }}
                                        className={`object-contain ${matchStarted ? '' : 'hover:opacity-70 transition'}`}
                                    />
                                ) : (
                                    !matchStarted && (
                                        <div
                                            style={{ height: 'clamp(6rem, 15vh, 18rem)', width: 'clamp(6rem, 15vh, 18rem)' }}
                                            className="border-2 border-dashed border-gray-400 rounded flex items-center justify-center hover:border-gray-600 transition"
                                        >
                                            <span style={{ fontSize: 'clamp(0.65rem, 0.8vw, 0.85rem)' }} className="text-gray-500">
                                                + Logo
                                            </span>
                                        </div>
                                    )
                                )}
                            </div>

                            {/* Team Name */}
                            <div className={`flex-1 ${textAlignClass}`}>
                                <div
                                    className="cursor-pointer hover:opacity-70 transition p-2 rounded"
                                    onClick={() => onChangeName(side)}
                                >
                                    <h2 className="font-bold uppercase" style={{ fontSize: 'clamp(1.75rem, 3vw, 3.5rem)' }}>
                                        {team.name}
                                    </h2>
                                </div>
                            </div>
                        </div>

                        {/* Timeouts below logo */}
                        <div className="flex items-center gap-2">
                            {manualEditMode && isLeft && (
                                <button
                                    onClick={() => onUpdateTimeouts(side, -1)}
                                    className={`${team.theme.buttonBg} ${team.theme.buttonText} ${team.theme.buttonHover} w-12 h-12 rounded-full text-2xl font-bold transition`}
                                >
                                    -
                                </button>
                            )}
                            <div
                                className="cursor-pointer hover:opacity-70 transition text-center"
                                onClick={() => onUpdateTimeouts(side, 1)}
                            >
                                <div className="font-bold text-4xl mb-2">TIMEOUT</div>
                                <div className="font-bold text-6xl">{team.timeouts}</div>
                            </div>
                            {manualEditMode && !isLeft && (
                                <button
                                    onClick={() => onUpdateTimeouts(side, -1)}
                                    className={`${team.theme.buttonBg} ${team.theme.buttonText} ${team.theme.buttonHover} w-12 h-12 rounded-full text-2xl font-bold transition`}
                                >
                                    -
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Score */}
                    <div className="flex-1 flex items-center min-h-0 px-4">
                        {isLeft && (
                            <button
                                onClick={() => onUpdateScore(side, -1)}
                                className={`${team.theme.buttonBg} ${team.theme.buttonText} ${team.theme.buttonHover} w-20 h-20 rounded-full text-4xl font-bold transition flex-shrink-0`}
                            >
                                -
                            </button>
                        )}
                        <div
                            style={{ fontSize: 'min(45vw, 90vh)' }}
                            className="font-bold cursor-pointer hover:opacity-70 transition leading-none flex-1 text-center"
                            onClick={() => onUpdateScore(side, 1)}
                        >
                            {team.score}
                        </div>
                        {!isLeft && (
                            <button
                                onClick={() => onUpdateScore(side, -1)}
                                className={`${team.theme.buttonBg} ${team.theme.buttonText} ${team.theme.buttonHover} w-20 h-20 rounded-full text-4xl font-bold transition flex-shrink-0`}
                            >
                                -
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        function VolleyScoreboard() {
            // Storage version - increment when breaking changes occur
            const STORAGE_VERSION = 2;

            // Default team configurations
            const DEFAULT_LEFT_TEAM = {
                name: 'Arcella Volley',
                score: 0,
                sets: 0,
                timeouts: 0,
                logo: 'https://www.arcellavolley.it/file/2014/05/Loghi-in-alto_051.png',
                theme: {
                    bgColor: 'bg-black',
                    textColor: 'text-white',
                    buttonBg: 'bg-white',
                    buttonText: 'text-black',
                    buttonHover: 'hover:bg-gray-200'
                }
            };

            const DEFAULT_RIGHT_TEAM = {
                name: 'Squadra Ospite',
                score: 0,
                sets: 0,
                timeouts: 0,
                logo: '',
                theme: {
                    bgColor: 'bg-white',
                    textColor: 'text-black',
                    buttonBg: 'bg-black',
                    buttonText: 'text-white',
                    buttonHover: 'hover:bg-gray-800'
                }
            };

            const [teamData, setTeamData] = useState({
                left: DEFAULT_LEFT_TEAM,
                right: DEFAULT_RIGHT_TEAM
            });

            const [setHistory, setSetHistory] = useState([]);
            const [menuOpen, setMenuOpen] = useState(false);
            const [manualEditMode, setManualEditMode] = useState(false);
            const [showConfetti, setShowConfetti] = useState(false);
            const [winnerMessage, setWinnerMessage] = useState('');

            const maxTimeouts = 2;

            // Load from localStorage on mount
            useEffect(() => {
                const saved = localStorage.getItem('volleyScoreboard');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);

                        // Check version - if mismatch, ignore saved data
                        if (data.version !== STORAGE_VERSION) {
                            console.log('Storage version mismatch - using defaults');
                            return;
                        }

                        // Load with defaults as fallback
                        setTeamData({
                            left: { ...DEFAULT_LEFT_TEAM, ...data.teamData.left },
                            right: { ...DEFAULT_RIGHT_TEAM, ...data.teamData.right }
                        });
                        setSetHistory(data.setHistory || []);
                    } catch (e) {
                        console.error('Error loading saved data:', e);
                    }
                }
            }, []);

            // Save to localStorage whenever state changes
            useEffect(() => {
                const data = {
                    version: STORAGE_VERSION,
                    teamData,
                    setHistory
                };
                localStorage.setItem('volleyScoreboard', JSON.stringify(data));
            }, [teamData, setHistory]);

            const updateScore = (team, delta) => {
                const newScore = Math.max(0, teamData[team].score + delta);
                setTeamData({
                    ...teamData,
                    [team]: { ...teamData[team], score: newScore }
                });
            };

            const updateSets = (team, delta) => {
                const newSets = Math.max(0, teamData[team].sets + delta);
                setTeamData({
                    ...teamData,
                    [team]: { ...teamData[team], sets: newSets }
                });
            };

            const updateTimeouts = (team, delta) => {
                const newTimeouts = Math.max(0, Math.min(maxTimeouts, teamData[team].timeouts + delta));
                setTeamData({
                    ...teamData,
                    [team]: { ...teamData[team], timeouts: newTimeouts }
                });
            };

            const changeName = (team) => {
                const newName = prompt(`Inserisci il nome della squadra:`, teamData[team].name);
                if (newName && newName.trim()) {
                    setTeamData({
                        ...teamData,
                        [team]: { ...teamData[team], name: newName.trim() }
                    });
                }
            };

            const changeLogo = (team) => {
                const newLogo = prompt(`Inserisci l'URL del logo:`, teamData[team].logo);
                if (newLogo !== null) {
                    setTeamData({
                        ...teamData,
                        [team]: { ...teamData[team], logo: newLogo.trim() }
                    });
                }
            };

            const switchSides = () => {
                setTeamData({
                    left: teamData.right,
                    right: teamData.left
                });
                setMenuOpen(false);
            };

            const endSet = () => {
                const winner = teamData.left.score > teamData.right.score ? 'left' : 'right';
                const loser = winner === 'left' ? 'right' : 'left';
                const winnerName = teamData[winner].name;

                if (teamData.left.score === teamData.right.score) {
                    alert('Il punteggio è pari! Non è possibile terminare il set.');
                    return;
                }

                setWinnerMessage(`${winnerName} ha vinto il set!`);
                setShowConfetti(true);

                // Save set history with team info and theme
                setSetHistory([...setHistory, {
                    leftScore: teamData.left.score,
                    rightScore: teamData.right.score,
                    leftTeamName: teamData.left.name,
                    rightTeamName: teamData.right.name,
                    winnerName: winnerName,
                    winnerTheme: teamData[winner].theme
                }]);

                setTimeout(() => {
                    // Increment set count for winner, reset scores and timeouts for both teams, then switch sides
                    setTeamData({
                        left: { ...teamData[loser], score: 0, timeouts: 0 },
                        right: { ...teamData[winner], sets: teamData[winner].sets + 1, score: 0, timeouts: 0 }
                    });

                    setTimeout(() => {
                        setShowConfetti(false);
                        setWinnerMessage('');
                    }, 500);
                }, 3000);

                setMenuOpen(false);
            };

            const resetSet = () => {
                if (confirm('Sei sicuro di voler resettare il set corrente?')) {
                    setTeamData({
                        left: { ...teamData.left, score: 0, timeouts: 0 },
                        right: { ...teamData.right, score: 0, timeouts: 0 }
                    });
                    setMenuOpen(false);
                }
            };

            const resetMatch = () => {
                if (confirm('Sei sicuro di voler resettare la partita?')) {
                    setTeamData({
                        left: DEFAULT_LEFT_TEAM,
                        right: DEFAULT_RIGHT_TEAM
                    });
                    setSetHistory([]);
                    setMenuOpen(false);
                }
            };

            const toggleManualEdit = () => {
                setManualEditMode(!manualEditMode);
                setMenuOpen(false);
            };

            const getCurrentDate = () => {
                const today = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return today.toLocaleDateString('it-IT', options);
            };

            const getCurrentSet = () => {
                return teamData.left.sets + teamData.right.sets + 1;
            };

            const matchStarted = teamData.left.score > 0 || teamData.right.score > 0 || teamData.left.sets > 0 || teamData.right.sets > 0;

            return (
                <div className="h-screen bg-black text-white flex flex-col relative overflow-hidden">
                    {/* Confetti Overlay */}
                    {showConfetti && (
                        <div className="fixed inset-0 z-50 pointer-events-none overflow-hidden">
                            <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                                <div className="text-6xl font-bold text-yellow-400 animate-pulse">
                                    {winnerMessage}
                                </div>
                            </div>
                            {[...Array(50)].map((_, i) => (
                                <div
                                    key={i}
                                    className="absolute animate-fall"
                                    style={{
                                        left: `${Math.random() * 100}%`,
                                        top: `-20px`,
                                        animationDelay: `${Math.random() * 0.5}s`,
                                        animationDuration: `${2 + Math.random() * 2}s`
                                    }}
                                >
                                    <div
                                        className={`w-3 h-3 ${
                                            Math.random() > 0.5 ? 'bg-yellow-400' : 'bg-white'
                                        } rounded-full`}
                                    />
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Top Stripe - Venue and Date */}
                    <div className="bg-yellow-400 text-black py-3 px-6">
                        <div className="flex justify-between items-center">
                            <div className="font-bold" style={{ fontSize: 'clamp(1rem, 1.5vw, 1.5rem)' }}>
                                Palestra "R. Barion"
                            </div>
                            <div className="font-semibold" style={{ fontSize: 'clamp(0.875rem, 1.2vw, 1.25rem)' }}>
                                {getCurrentDate()}
                            </div>
                        </div>
                    </div>

                    {/* Main Scoreboard */}
                    <div className="flex-1 flex min-h-0">
                        <TeamPanel
                            side="left"
                            team={teamData.left}
                            matchStarted={matchStarted}
                            manualEditMode={manualEditMode}
                            onChangeName={changeName}
                            onChangeLogo={changeLogo}
                            onUpdateTimeouts={updateTimeouts}
                            onUpdateScore={updateScore}
                        />

                        {/* Center Divider with Menu and Current Set */}
                        <div className="w-40 bg-yellow-400 flex flex-col relative">
                            {/* Current Set Indicator - At Top */}
                            <div className="py-6 text-center border-b-2 border-black">
                                <div className="text-black font-bold mb-2" style={{ fontSize: 'clamp(1.5rem, 2.25vw, 2.25rem)' }}>
                                    SET
                                </div>
                                <div className="text-black font-bold" style={{ fontSize: 'clamp(4.5rem, 7.5vw, 9rem)' }}>
                                    {getCurrentSet()}
                                </div>
                            </div>

                            {/* Sets Won Display */}
                            <div className="py-4 text-center border-b-2 border-black">
                                <div className="text-black font-bold mb-2" style={{ fontSize: 'clamp(1rem, 1.5vw, 1.5rem)' }}>
                                    SET
                                </div>
                                <div className="flex justify-center items-center gap-4">
                                    <div className="text-black font-bold text-5xl">{teamData.left.sets}</div>
                                    <div className="text-black font-bold text-2xl">-</div>
                                    <div className="text-black font-bold text-5xl">{teamData.right.sets}</div>
                                </div>
                            </div>

                            {/* Set History Bubbles - Vertically Stacked */}
                            <div className="flex-1 flex flex-col items-center justify-start py-4 overflow-y-auto">
                                {setHistory.length > 0 && (
                                    <div className="flex flex-col gap-4 w-full px-4">
                                        {setHistory.map((set, index) => {
                                            // Use the saved winner theme for color
                                            const winnerTheme = set.winnerTheme || { bgColor: 'bg-black', textColor: 'text-white' };
                                            const winnerColor = `${winnerTheme.bgColor} ${winnerTheme.textColor}`;

                                            // Determine scores based on CURRENT team positions
                                            // We need to find which historical score belongs to the current left/right team
                                            let currentLeftScore, currentRightScore;

                                            // Check if the current left team was on the left when this set was played
                                            if (teamData.left.name === set.leftTeamName) {
                                                // No swap needed - current left was historical left
                                                currentLeftScore = set.leftScore;
                                                currentRightScore = set.rightScore;
                                            } else {
                                                // Swap needed - current left was historical right
                                                currentLeftScore = set.rightScore;
                                                currentRightScore = set.leftScore;
                                            }

                                            return (
                                                <div
                                                    key={index}
                                                    className={`${winnerColor} rounded-lg px-4 py-3 text-center`}
                                                >
                                                    <div className="text-lg opacity-70 mb-2">
                                                        Set {index + 1}
                                                    </div>
                                                    <div className="font-bold text-2xl">
                                                        {currentLeftScore}-{currentRightScore}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>

                            {/* Menu Button */}
                            <div className="relative">
                                <button
                                    onClick={() => setMenuOpen(!menuOpen)}
                                    className="w-full py-4 bg-black text-yellow-400 hover:bg-gray-900 transition flex items-center justify-center"
                                >
                                    <Menu size={24} />
                                </button>

                                {menuOpen && (
                                    <div className="absolute bottom-full left-0 right-0 bg-black border-2 border-yellow-400 shadow-lg">
                                        <button
                                            onClick={endSet}
                                            className="w-full py-3 px-4 text-yellow-400 hover:bg-gray-900 transition flex items-center justify-center gap-2 border-b border-yellow-400"
                                        >
                                            <Flag size={18} />
                                            <span className="text-sm">Fine Set</span>
                                        </button>
                                        <button
                                            onClick={switchSides}
                                            className="w-full py-3 px-4 text-yellow-400 hover:bg-gray-900 transition flex items-center justify-center gap-2 border-b border-yellow-400"
                                        >
                                            <RotateCw size={18} />
                                            <span className="text-sm">Cambia Lato</span>
                                        </button>
                                        <button
                                            onClick={toggleManualEdit}
                                            className="w-full py-3 px-4 text-yellow-400 hover:bg-gray-900 transition flex items-center justify-center gap-2 border-b border-yellow-400"
                                        >
                                            <Edit size={18} />
                                            <span className="text-sm">{manualEditMode ? 'Esci Modifica' : 'Modifica Manuale'}</span>
                                        </button>
                                        <button
                                            onClick={resetSet}
                                            className="w-full py-3 px-4 text-yellow-400 hover:bg-gray-900 transition flex items-center justify-center gap-2 border-b border-yellow-400"
                                        >
                                            <RotateCw size={18} />
                                            <span className="text-sm">Reset Set</span>
                                        </button>
                                        <button
                                            onClick={resetMatch}
                                            className="w-full py-3 px-4 text-yellow-400 hover:bg-gray-900 transition flex items-center justify-center gap-2"
                                        >
                                            <RotateCw size={18} />
                                            <span className="text-sm">Reset Partita</span>
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>

                        <TeamPanel
                            side="right"
                            team={teamData.right}
                            matchStarted={matchStarted}
                            manualEditMode={manualEditMode}
                            onChangeName={changeName}
                            onChangeLogo={changeLogo}
                            onUpdateTimeouts={updateTimeouts}
                            onUpdateScore={updateScore}
                        />
                    </div>
                </div>
            );
        }

        ReactDOM.render(<VolleyScoreboard />, document.getElementById('root'));
    </script>
</body>
</html>
